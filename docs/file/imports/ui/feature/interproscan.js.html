<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../../">
  <title data-ice="title">imports/ui/feature/interproscan.js | genebook</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="A portable website for browsing and querying genome sequences and annotations"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="genebook"><meta property="twitter:description" content="A portable website for browsing and querying genome sequences and annotations"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/holmrenser/genebook"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#api-blast">api/blast</a><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-hasBlastDb">hasBlastDb</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-makeBlastDb">makeBlastDb</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-removeBlastDb">removeBlastDb</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-submitBlastJob">submitBlastJob</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#api-downloads">api/downloads</a><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Downloads">Downloads</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#api-genes">api/genes</a><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-addInterproscan">addInterproscan</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-addOrthogroupTrees">addOrthogroupTrees</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Attributes">Attributes</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Downloads">Downloads</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-downloadGenes">downloadGenes</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-EditHistory">EditHistory</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-GeneSchema">GeneSchema</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Genes">Genes</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-SubfeatureSchema">SubfeatureSchema</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Interpro">Interpro</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Orthogroups">Orthogroups</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-scanGeneAttributes">scanGeneAttributes</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#api-genomes">api/genomes</a><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-addGff">addGff</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-addReference">addReference</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ReferenceInfo">ReferenceInfo</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ReferenceInfoSchema">ReferenceInfoSchema</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ReferenceSchema">ReferenceSchema</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-References">References</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Tracks">Tracks</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-trackSchema">trackSchema</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-updateTrackPermissions">updateTrackPermissions</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#api-transcriptomes">api/transcriptomes</a><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ExperimentInfo">ExperimentInfo</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ExperimentInfoSchema">ExperimentInfoSchema</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-TranscriptomeSchema">TranscriptomeSchema</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Transcriptomes">Transcriptomes</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-updateSampleInfo">updateSampleInfo</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#api-users">api/users</a><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-updateUserInfo">updateUserInfo</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#api-util">api/util</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-formatAttributes">formatAttributes</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getGeneSequences">getGeneSequences</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-parseNewick">parseNewick</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-reverseComplement">reverseComplement</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-translate">translate</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#ui-admin">ui/admin</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-JobProgressBar">JobProgressBar</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#ui-admin-tracks">ui/admin/tracks</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/imports/ui/admin/tracks/TrackPermissionSelect.jsx~TrackPermissionSelect.html">TrackPermissionSelect</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-AdminTrackInfo">AdminTrackInfo</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-BlastDatabaseButtons">BlastDatabaseButtons</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-BlastDatabaseProgressBar">BlastDatabaseProgressBar</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#ui-admin-transcriptomes">ui/admin/transcriptomes</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/imports/ui/admin/transcriptomes/ExperimentGroup.jsx~ExperimentGroup.html">ExperimentGroup</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/imports/ui/admin/transcriptomes/SampleInfo.jsx~SampleInfo.html">SampleInfo</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/imports/ui/admin/transcriptomes/TrackExperiments.jsx~TrackExperiments.html">TrackExperiments</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#ui-blast">ui/blast</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/imports/ui/blast/BlastResultList.jsx~BlastResultList.html">BlastResultList</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/imports/ui/blast/BlastResultPlot.jsx~BlastResultPlot.html">BlastResultPlot</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#ui-feature">ui/feature</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/imports/ui/feature/ProteinDomains.jsx~ProteinDomains.html">ProteinDomains</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/imports/ui/feature/Seq.jsx~SeqContainer.html">SeqContainer</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#ui-genelist">ui/genelist</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/imports/ui/genelist/AttributeSelect.jsx~AttributeSelect.html">AttributeSelect</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/imports/ui/genelist/GeneTableCard.jsx~GeneTableCard.html">GeneTableCard</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/imports/ui/genelist/GeneTableOptions.jsx~GeneTableOptions.html">GeneTableOptions</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-ThreewayRadioButtons">ThreewayRadioButtons</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-TrackSelect">TrackSelect</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#ui-genelist-downloads">ui/genelist/downloads</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/imports/ui/genelist/downloads/DownloadDialog.jsx~DownloadDialogModal.html">DownloadDialogModal</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#ui-landingpage">ui/landingpage</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/imports/ui/landingpage/Landingpage.jsx~Landingpage.html">Landingpage</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#ui-main">ui/main</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/imports/ui/main/MainLayout.jsx~MainLayout.html">MainLayout</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-InactiveAccountWarning">InactiveAccountWarning</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-NotFound">NotFound</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#ui-util">ui/util</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Loading">Loading</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isLoading">isLoading</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-withEither">withEither</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">imports/ui/feature/interproscan.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import { Meteor } from &apos;meteor/meteor&apos;;
import { Template } from &apos;meteor/templating&apos;;

import d3 from &apos;d3&apos;;
import lodash from &apos;lodash&apos;;
import { schemeSet3 } from &apos;d3-scale-chromatic&apos;;

import { InterPro } from &apos;/imports/api/genes/interpro_collection.js&apos;;

import &apos;./interproscan.html&apos;;
import &apos;./interproscan.js&apos;;

_ = lodash;

Meteor.subscribe(&apos;interpro&apos;);

function getInterproId(d){
	let interpro;
    let found = false;
	dbxref = d.dbxref.split(&apos;,&apos;);
	for (let dbString of dbxref){
        let db = dbString.split(&apos;:&apos;)
		if (db[0] === &apos;InterPro&apos;) {
			interpro = db[1]
            found = true
		}
	}
    if (!found){
        interpro = &apos;Unintegrated&apos;
    }
	return interpro
}

function getInterproMetaData(groupedData){
    const interproIds = Object.keys(groupedData)
    const unintegrated = interproIds.indexOf(&apos;Unintegrated&apos;);
    if (unintegrated &gt; 0){
        interproIds.splice(unintegrated,1)
    }
    if (interproIds.length !== 0){
        const ipr = Interpro.find().fetch();
        const groupedIpr = _.groupBy(ipr,function(i){ return i.ID })
        const flattenedIpr = _.mapValues(groupedIpr,function(val){ return val[0] })
        return flattenedIpr
    } 
}


Template.interproscan.helpers({
    transcripts : function(){
        return this.subfeatures.filter(function(x){return x.type === &apos;mRNA&apos;})
    },
    domains:function(){
        return Interpro.find({&apos;ID&apos;:{$in:this.domains.InterPro}})
    }
})

Template.interproscan.rendered = function(){
    const transcript = this.data.subfeatures.filter(function(x){return x.type === &apos;mRNA&apos;})[0];
    const id = transcript.ID;
    const data = _.values(transcript.interproscan).sort(function(a,b){return a.start-b.start});
    const groupedData = _.groupBy(data,function(d){return getInterproId(d)})
    const interproMetaData = getInterproMetaData(groupedData)
    const DataArray = _.values(groupedData)

    const groupedDataArray = DataArray.map(function(domain){
        let domainObj = _.groupBy(domain,function(d){return d.source})
        let domainList = _.values(domainObj)
        return domainList
    })

    const lineHeight = 10;
    const nameSpacing = 140

    var margin = {top: 10, right: 10, bottom: 10, left: 10};
    var width = $(&apos;.interproscan&apos;).width() - margin.left - margin.right;
    var height = (lineHeight * data.length) - margin.top

    //set min and max values
    var start = 0;
    var end = transcript.seq.length;

    //setup x scale 
    var xScale = d3.scaleLinear()
            .domain([0,end])
            .range([nameSpacing,width])

    //setup svg
    var svg = d3.select(&apos;.interproscan&apos;).append(&apos;svg&apos;)
            .attr(&apos;width&apos;,width + margin.left + margin.right)
            .attr(&apos;height&apos;,height + margin.top + margin.bottom + 20)
        .append(&apos;g&apos;)
            .attr(&apos;class&apos;,&apos;container&apos;)
            .attr(&apos;transform&apos;,&apos;translate(&apos; + margin.left + &apos;,&apos; + margin.top + &apos;)&apos;)

    //draw axis first, so it sits nicely in the back
    var xAxis = d3.axisBottom(xScale)
            .ticks(10)
            .tickPadding(-height - margin.top - margin.bottom - 20)
            .tickSize(height + margin.top + margin.bottom)

    svg.append(&apos;g&apos;)
            .attr(&apos;class&apos;,&apos;x axis&apos;)
            .attr(&apos;transform&apos;,&apos;translate(0,10)&apos;)
            .call(xAxis)
        .selectAll(&apos;text&apos;)
            .attr(&apos;transform&apos;,&apos;rotate(0)&apos;)
            .style(&apos;text-anchor&apos;,&apos;start&apos;)

    //make domain groups
    let domainCounter = 0
    var domains = svg.selectAll(&apos;.domain&apos;)
            .data(groupedDataArray)
        .enter().append(&apos;g&apos;)
            .attr(&apos;class&apos;,&apos;domain&apos;)
            .attr(&apos;transform&apos;,function(d,i){
                domainCounter += d.length
                return &apos;translate(0,&apos; + (((domainCounter - d.length) * (lineHeight + 10)) + 15) + &apos;)&apos;
            })

    var sources = domains.selectAll(&apos;.source&apos;)
            .data(function(source){
                return source
            })
        .enter().append(&apos;g&apos;)
            .attr(&apos;class&apos;,&apos;source&apos;)
            .attr(&apos;transform&apos;,function(d,i){
                return &apos;translate(0,&apos; + i * lineHeight + &apos;)&apos;
            })
    //draw domains
    var rect = sources.selectAll(&apos;rect&apos;)
            .data(function(domain){
                return domain
            })
        .enter().append(&apos;rect&apos;)
            .attr(&apos;x&apos;,function(d){
                return xScale(d.start * 3)
            })
            .attr(&apos;width&apos;,function(d){
                return xScale(d.end * 3) - xScale(d.start * 3)
            })
            .attr(&apos;y&apos;,function(d,i){
                return 0//i * 15
            })
            .attr(&apos;height&apos;,7)
            .attr(&apos;rx&apos;,2)
            .attr(&apos;ry&apos;,2)
            .each(function(d,i){
                //initialize bootstrap popover for every rect, bootstrap popup dismissal is automatically taken care of by code in client/main/app-body.js
                $(this).popover({
                    title:d.name,
                    html:true,
                    content:function(){
                        let content = &apos;Source: &apos; + d.source + &apos;&lt;br&gt;&apos;
                        if (d.signature_desc) {
                            content += &apos;Description: &apos; + d.signature_desc
                        }
                        return content
                    },
                    container:$(&apos;#interproscan&apos;),
                    placement:&apos;top&apos;
                })
            })
            .style(&apos;fill&apos;,function(d){
                let interpro = getInterproId(d)
                if (interpro !== &apos;Unintegrated&apos;){
                    return interproMetaData[interpro].color
                } else {
                    return &apos;grey&apos;
                }
            })
            .style(&apos;opacity&apos;,1)
            .style(&apos;stroke&apos;,&apos;black&apos;)
            .style(&apos;stroke-width&apos;,0.5)
    //add domain names
    var domainIds = domains.selectAll(&apos;foreignObject&apos;)
            .data(function(domain){
                return [domain[0][0]]
            })
        .enter().append(&apos;foreignObject&apos;)
            .attr(&apos;x&apos;,0)
            .attr(&apos;y&apos;,0)
            .html(function(d){
                let ipr = getInterproId(d)
                return &apos;&lt;button type=&quot;button&quot; class=&quot;btn btn-default btn-xs&quot;&gt;&apos; + ipr + &apos;&lt;/button&gt;&apos;
            })
    /*
    var names = domains.selectAll(&apos;text&apos;)
            .data(function(domain){
                console.log(domain)
                return [domain[0][0]]
            })
        .enter().append(&apos;text&apos;)
            .attr(&apos;x&apos;,0)
            .attr(&apos;y&apos;,10)
            .text(function(d){ 
                let ipr = getInterproId(d)
                if (ipr === &apos;Unintegrated&apos;){
                    return &apos;Unintegrated&apos;
                } else {
                    return ipr + &apos; &apos; + interproMetaData[ipr].description
                }
            })
    */

    
    function update(){
        width = $(&apos;.interproscan&apos;).width() - margin.left - margin.right;
        xScale.range([nameSpacing,width])
        svg.attr(&apos;width&apos;,width)
        rect.attr(&apos;x&apos;,function(d){ 
            return xScale(d.start * 3)
        })
        .attr(&apos;width&apos;,function(d){
            return xScale(d.end * 3) - xScale(d.start * 3)
        })

        xAxis.scale(xScale)
        svg.select(&apos;g.x.axis&apos;).call(xAxis)
    }

    $(window).resize(function() {
        update()
    }).trigger(&quot;resize&quot;);
}

</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.0.4)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
